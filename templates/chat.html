<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Chat Room with File Sharing & Image Preview</title>
<style>
  * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
  body { background: linear-gradient(135deg,#0078ff,#00d4ff); height:100vh; margin:0; display:flex; justify-content:center; align-items:center; }
  .chat-container { width:700px; background:white; border-radius:12px; box-shadow:0 6px 30px rgba(0,0,0,0.2); display:flex; flex-direction:column; overflow:hidden; }
  .header { padding:12px 16px; background:#0078ff; color:white; display:flex; justify-content:space-between; align-items:center; }
  #chat-box { flex:1; padding:16px; background:#f9f9f9; overflow:auto; display:flex; flex-direction:column; gap:8px; }
  .message { max-width:70%; padding:10px 12px; border-radius:10px; word-wrap:break-word; }
  .me { align-self:flex-end; background:#d1f0ff; border-bottom-right-radius:0; }
  .other { align-self:flex-start; background:#ececec; border-bottom-left-radius:0; }
  .system { align-self:center; color:#666; font-size:13px; background:transparent; }
  .timestamp { display:block; font-size:10px; color:#555; margin-top:6px; text-align:right; }
  #controls { display:flex; padding:12px; border-top:1px solid #eee; gap:8px; }
  #msg { flex:1; padding:10px; border-radius:8px; border:1px solid #ccc; }
  button { padding:10px 14px; border-radius:8px; background:#0078ff; color:white; border:none; cursor:pointer; }
  input[type=file] { display:none; }
  label.upload-btn {
    background:#0078ff; color:white; padding:10px 14px; border-radius:8px; cursor:pointer;
  }
  img.preview {
    max-width:200px; max-height:200px; margin-top:5px; border-radius:8px; display:block;
  }
</style>
</head>
<body>
<div class="chat-container">
  <div class="header">
    <div>ðŸ’¬ Chat â€” {{ username }}</div>
    <div><a href="/" style="color:white;text-decoration:none;">Logout</a></div>
  </div>

  <div id="chat-box"></div>

  <div id="controls">
    <input id="msg" placeholder="Type a message..." />
    <label for="file-input" class="upload-btn">ðŸ“Ž</label>
    <input type="file" id="file-input" />
    <button id="send">Send</button>
  </div>
</div>

<script>
const USERNAME = "{{ username }}";
const ROOM = "main";
let ws = new WebSocket(`ws://${location.host}/ws/${ROOM}?username=${USERNAME}`);

const chatBox = document.getElementById('chat-box');
const msgInput = document.getElementById('msg');
const sendBtn = document.getElementById('send');
const fileInput = document.getElementById('file-input');

function addMessage(user, content, cls='other') {
  const div = document.createElement('div');
  div.className = 'message ' + cls;
  const time = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});

  if (cls === 'system') {
    div.textContent = content;
  } else {
    div.innerHTML = `<b>${user}</b><div>${content}</div><span class="timestamp">${time}</span>`;
  }

  chatBox.appendChild(div);
  chatBox.scrollTop = chatBox.scrollHeight;
}

//Handle incoming messages
ws.onmessage = (e) => {
  const data = JSON.parse(e.data);

  if (data.system) {
    addMessage('System', data.system, 'system');
    return;
  }

  // Handle file
  if (data.type === "file") {
    const isMe = data.username === USERNAME;
    if (isMe) return; // âœ… prevent duplicate file message for sender

    let content;
    if (/\.(jpg|jpeg|png|gif|webp)$/i.test(data.filename)) {
      content = `<a href="${data.url}" target="_blank">${data.filename}</a>
                 <img src="${data.url}" alt="${data.filename}" class="preview" />`;
    } else {
      content = `<a href="${data.url}" target="_blank">${data.filename}</a>`;
    }
    addMessage(data.username + " (File)", content, 'other');
    return;
  }

  // Normal text messages
  if (data.username && data.message) {
    const isMe = data.username === USERNAME;
    addMessage(isMe ? 'You' : data.username, data.message, isMe ? 'me' : 'other');
  }
};

// âœ… Send text message
function sendMessage() {
  const text = msgInput.value.trim();
  if (!text) return;
  ws.send(JSON.stringify({ message: text }));
  msgInput.value = '';
}
sendBtn.onclick = sendMessage;

// âœ… Send message on Enter key
msgInput.addEventListener("keydown", (e) => {
  if (e.key === "Enter" && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
});

// âœ… File upload
fileInput.onchange = async () => {
  const file = fileInput.files[0];
  if (!file) return;

  const formData = new FormData();
  formData.append("file", file);
  formData.append("username", USERNAME);
  formData.append("room", ROOM);

  const res = await fetch("/upload", { method: "POST", body: formData });
  const data = await res.json();

  if (data.url) {
    // âœ… Show file instantly (no duplicate after WebSocket broadcast)
    let content;
    if (/\.(jpg|jpeg|png|gif|webp)$/i.test(file.name)) {
      content = `<a href="${data.url}" target="_blank">${file.name}</a>
                 <img src="${data.url}" alt="${file.name}" class="preview" />`;
    } else {
      content = `<a href="${data.url}" target="_blank">${file.name}</a>`;
    }
    addMessage("You (File)", content, "me");
  }

  fileInput.value = ""; // reset input
};
</script>
</body>
</html>

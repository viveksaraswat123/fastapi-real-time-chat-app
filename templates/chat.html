<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>FastAPI Real-Time Chat</title>
<style>
  * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
  body {
    background: linear-gradient(135deg, #d9dce1, #00d4ff);
    height: 100vh; display: flex; justify-content: center; align-items: center;
    margin: 0;
  }
  .chat-container {
    width: 420px; background: white; border-radius: 12px; overflow: hidden;
    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    display: flex; 
    flex-direction: column;
  }
  .header {
    background: #0078ff; color: white; padding: 12px; text-align: center;
    font-weight: bold; letter-spacing: 1px;
  }
  #chat-box {
    flex: 1; padding: 10px; overflow-y: auto; background: #f9f9f9;
    display: flex; flex-direction: column;
  }
  .message {
    max-width: 75%; margin: 5px 0; padding: 8px 12px; border-radius: 10px;
    position: relative; word-wrap: break-word; animation: fadeIn 0.3s ease-in;
  }
  .me { align-self: flex-end; background: #d1f0ff; border-bottom-right-radius: 0; }
  .other { align-self: flex-start; background: #ebebeb; border-bottom-left-radius: 0; }
  .system { align-self: center; background: transparent; color: gray; font-size: 13px; }
  .timestamp {
    display: block; text-align: right; font-size: 10px; color: gray; margin-top: 2px;
  }
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  #controls {
    display: flex; border-top: 1px solid #ddd;
  }
  #msg {
    flex: 1; border: none; padding: 10px; font-size: 14px;
  }
  #msg:focus { outline: none; }
  #send {
    background: #0078ff; color: white; border: none; padding: 10px 16px;
    cursor: pointer; font-weight: bold;
  }
  #send:disabled { background: #ccc; cursor: not-allowed; }
  .top-inputs {
    padding: 10px; display: flex; flex-direction: column; gap: 8px;
    background: #f0f6ff;
  }
  .top-inputs input {
    padding: 8px; border: 1px solid #ccc; border-radius: 8px; font-size: 14px;
  }
  .top-inputs button {
    background: #0078ff; color: white; border: none; padding: 10px;
    border-radius: 8px; cursor: pointer; font-weight: bold;
  }
  #typing { font-size: 12px; color: gray; margin: 4px 12px; height: 16px; }
</style>
</head>
<body>
<div class="chat-container">
  <div class="header">FastAPI Chat</div>
  <div class="top-inputs">
    <input id="username" placeholder="Enter username">
    <input id="room" placeholder="Enter room name">
    <button id="connect">Join Room</button>
  </div>
  <div id="chat-box"></div>
  <div id="typing"></div>
  <div id="controls">
    <input id="msg" placeholder="Type a message..." disabled>
    <button id="send" disabled>Send</button>
  </div>
</div>

<script>
let ws = null;
let username = "";
let room = "";
const chatBox = document.getElementById('chat-box');
const msgInput = document.getElementById('msg');
const sendBtn = document.getElementById('send');
const connectBtn = document.getElementById('connect');
const typingDiv = document.getElementById('typing');

function addMessage(user, text, type='other') {
  const div = document.createElement('div');
  div.className = 'message ' + type;
  if (type !== 'system') {
    const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    div.innerHTML = `<b>${user}</b><br>${text}<span class="timestamp">${time}</span>`;
  } else {
    div.textContent = text;
  }
  chatBox.appendChild(div);
  chatBox.scrollTop = chatBox.scrollHeight;
}

connectBtn.onclick = () => {
  username = document.getElementById('username').value.trim() || 'Anonymous';
  room = document.getElementById('room').value.trim() || 'general';
  ws = new WebSocket(`ws://${location.host}/ws/${room}?username=${username}`);
  ws.onopen = () => {
    addMessage('System', `You joined room: ${room}`, 'system');
    connectBtn.disabled = true; msgInput.disabled = false; sendBtn.disabled = false;
  };
  ws.onmessage = (e) => {
    const data = JSON.parse(e.data);
    if (data.type === 'typing') {
      typingDiv.textContent = data.username + " is typing...";
      clearTimeout(window.typingTimeout);
      window.typingTimeout = setTimeout(() => typingDiv.textContent = "", 1000);
    } else if (data.username && data.message) {
      const isMe = data.username === username;
      addMessage(isMe ? 'You' : data.username, data.message, isMe ? 'me' : 'other');
    } else if (data.system) {
      addMessage('System', data.system, 'system');
    }
  };
  ws.onclose = () => {
    addMessage('System', 'Connection closed.', 'system');
    connectBtn.disabled = false; msgInput.disabled = true; sendBtn.disabled = true;
  };
};

sendBtn.onclick = () => {
  const text = msgInput.value.trim();
  if (!text) return;
  ws.send(JSON.stringify({ message: text }));
  msgInput.value = '';
};

msgInput.addEventListener('keyup', e => {
  if (e.key === 'Enter') sendBtn.click();
  else ws && ws.send(JSON.stringify({ typing: true }));
});
</script>
</body>
</html>
